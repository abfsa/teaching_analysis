## 项目说明

本项目用于使用大语言模型处理多模态教学资料并进行教学行为与内容的分析评价。

## 使用方法

该项目本体为接口，运行服务后，接口将持续接受请求，解析请求中的资源地址并下载，随后调用讯飞转写、通义千问等工具进行分析，最后向指定地址发送分析结果。如果您需要部署接口，请在项目中添加 `env` 文件并设置回调接口、密钥等。

## 代码说明

项目环境构建见 `requirements.txt` 文件。

### app.tools

`app.tools` 中包含该接口的核心代码，即使用讯飞转写、通义千问处理教学音频、文档素材的函数。代码可分为三类：

1. util：包含分析模块的基础功能
2. video_transformer：教学视频预处理
3. 内容分析模块工具

这些工具中定义的函数将在 `analyze.py` 中得到充分应用，从而得到完整的分析结果。

#### util.py

加载.env文件获取调用大模型必须的密钥，并定义以下函数，用于其他工具的实现：

- `get_response`：输入提示词，并以字符串形式输出通义千问的处理结果

- `extract_json_from_string`：使用正则表达式匹配字符串中的json格式部分
- `retry_on_failure`：装饰器，自动重试失败函数，用于提高大模型转写的结果准确率，避免因报错中断接口运行

#### video_transformer.py

定义调用讯飞转写处理音频文件，得到json格式字幕的函数。格式如下：

```
{
	'id':1,
	'start':,
	'end':,
	'content':,
	'speaker':
}
{...}
```

`generate_subtitles`：输入音频文件地址，调用讯飞api进行分析，得到以上字符串格式的字幕并返回。自带失败重试，最大重试次数为2。

#### 内容分析模块工具

定义了不同的分析函数，通过输入字幕等内容得到分析结果。具备失败重试能力。

- `generate_video/doc_tree.py`：输入字幕/文档得到树状知识图谱
- `generate_coverage.py`：输入video/doc_tree得到视频和文档的对比分析结果
- `new_outline.py`：输入字幕得到教学大纲
- `generate_report.py`：输入字幕和树状知识图谱得到分析报告

> <font color="lightblue">在这里添加教学行为分析的函数定义文件。可以重复利用之前定义的装饰器等工具。</font>

### analyze.py

通过调用 `app.tools` 中实现的函数完成教学内容分享。定义关键分析函数 `analyze_content`，输入值为音频地址和教学大纲文件地址（如果存在教学大纲文件），按如下顺序分析：

1. 音频转录为字幕
2. 生成视频图谱
3. 生成教案图谱
4. 生成新教案
5. 生成教学内容分析报告
6. <font color="lightblue">在这里添加教学行为分析的函数调用和结果返回</font>
7. 将以上步骤返回的结果整合为一个json对象并返回

接口将会为每个上传的视频对象生成一个分析进程，并在以上分析完成后将结果发送到指定地点。

